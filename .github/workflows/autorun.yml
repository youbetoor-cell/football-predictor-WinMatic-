name: WinMatic Auto Run

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch: {}

jobs:
  autorun:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Call backend maintenance endpoints
        env:
          BASE_URL: ${{ secrets.BASE_URL }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          set -euo pipefail

          echo "BASE_URL=$BASE_URL"

          echo "1) Sync results (writes finished fixtures/results)"
          for L in 39 140 135 78 61; do
            echo " - sync league=$L"
            curl -fsS -X POST "$BASE_URL/results/sync?league=$L&lookback_days=21&max_fixtures=100" \
              -H "X-Admin-Token: $ADMIN_TOKEN" \
              -H "Content-Type: application/json" \
              -d '{}' | head -c 400 || true
            echo
          done

          echo "2) Update history rows with actual results + derived metrics"
          for L in 39 140 135 78 61; do
            echo " - update league=$L"
            curl -fsS "$BASE_URL/update-results?league=$L&max_updates=100" \
              -H "X-Admin-Token: $ADMIN_TOKEN" \
              | head -c 400 || true
            echo
          done

          echo "3) Warm value scan + odds cache (key leagues)"
          for L in 39 140 135 78 61; do
            echo " - warm league=$L"
            curl -fsS "$BASE_URL/value/upcoming?league=$L&days_ahead=7&limit=50&min_edge=0.03" > /dev/null || true
          done

          echo "done"
