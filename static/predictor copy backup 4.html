<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WinMatic – AI Football Predictions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --bg-soft: #020617;
      --border-subtle: #1f2937;
      --accent: #ef4444;
      --accent-blue: #3b82f6;
      --accent-green: #22c55e;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --text-softer: #6b7280;
      --radius-lg: 20px;
      --radius-md: 14px;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.6);
      --shadow-card: 0 12px 34px rgba(15, 23, 42, 0.95);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #0b1120 0, #020617 45%, #020617 100%);
      color: var(--text);
      display: flex;
    }

    /* Sidebar */

    .sidebar {
      width: 230px;
      background: linear-gradient(180deg, #020617 0, #020617 40%, #020617 100%);
      border-right: 1px solid #111827;
      padding: 18px 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      position: sticky;
      top: 0;
      height: 100vh;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-logo {
      width: 34px;
      height: 34px;
      border-radius: 9999px;
      background: radial-gradient(circle at 30% 20%, #f97316, #ef4444 40%, #3b82f6 100%);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.8), 0 0 40px rgba(239, 68, 68, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 1.1rem;
    }

    .brand-text { line-height: 1.1; }
    .brand-name {
      font-weight: 800;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 0.9rem;
    }
    .brand-tagline {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .nav {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .nav-item {
      border-radius: 9999px;
      padding: 8px 10px;
      font-size: 0.86rem;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.18s ease-out;
    }
    .nav-item::before {
      content: "●";
      font-size: 0.5rem;
      opacity: 0.7;
    }
    .nav-item:hover {
      background: #020617;
      color: var(--text);
      border-color: #111827;
    }
    .nav-item.active {
      background: rgba(239, 68, 68, 0.12);
      border-color: rgba(239, 68, 68, 0.45);
      color: #fecaca;
      box-shadow: 0 0 24px rgba(239, 68, 68, 0.35);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 0.75rem;
      color: var(--text-softer);
    }
    .sidebar-footer code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.72rem;
      background: #020617;
      padding: 1px 4px;
      border-radius: 4px;
      border: 1px solid #111827;
    }

    /* Responsive tweaks for sidebar */

    @media (max-width: 860px) {
      body { flex-direction: column; }
      .sidebar {
        position: relative;
        width: 100%;
        height: auto;
        flex-direction: row;
        align-items: center;
        gap: 10px;
      }
      .nav {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 4px;
      }
      .sidebar-footer { display: none; }
    }

    /* Main */

    .main {
      flex: 1;
      padding: 18px 20px 18px;
      overflow-y: auto;
    }

    /* Hero */

    .hero {
      position: relative;
      margin-bottom: 20px;
      border-radius: var(--radius-lg);
      padding: 18px 18px 18px;
      border: 1px solid var(--border-subtle);
      background:
        radial-gradient(circle at top left, rgba(239, 68, 68, 0.17), transparent 55%),
        radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.18), transparent 55%),
        #020617;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }
    .hero-glow {
      position: absolute;
      width: 260px;
      height: 260px;
      background: radial-gradient(circle, rgba(239, 68, 68, 0.2), transparent 60%);
      top: -120px;
      right: -70px;
      filter: blur(2px);
      opacity: 0.8;
      pointer-events: none;
      animation: floatGlow 8s ease-in-out infinite alternate;
    }
    @keyframes floatGlow {
      0% { transform: translate3d(0,0,0) scale(1); opacity: 0.6; }
      100% { transform: translate3d(-18px,20px,0) scale(1.08); opacity: 1; }
    }

    .hero-content {
      position: relative;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .hero-left { max-width: 520px; }

    .eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 9999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.25);
      font-size: 0.72rem;
      color: var(--text-soft);
      margin-bottom: 7px;
    }
    .eyebrow-dot {
      width: 7px;
      height: 7px;
      border-radius: 9999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
    }

    .hero-title {
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: 0.02em;
      margin: 0 0 6px;
    }
    .hero-highlight { color: #fecaca; }
    .hero-subtitle {
      font-size: 0.92rem;
      color: var(--text-soft);
      max-width: 440px;
      line-height: 1.45;
    }

    .hero-buttons {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .btn {
      border-radius: 9999px;
      padding: 7px 14px;
      border: none;
      cursor: pointer;
      font-size: 0.86rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.18s ease-out;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #f97316);
      color: #f9fafb;
      box-shadow: 0 0 25px rgba(239, 68, 68, 0.55);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 36px rgba(239, 68, 68, 0.85);
    }
    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    .btn-secondary:hover {
      background: rgba(15, 23, 42, 1);
      color: var(--text);
    }

    .hero-right {
      min-width: 180px;
      max-width: 230px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 9px 12px;
      background: rgba(15, 23, 42, 0.96);
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.9);
      font-size: 0.78rem;
    }
    .hero-right-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .hero-right-row {
      display: flex;
      justify-content: space-between;
      margin-top: 3px;
    }
    .hero-right-label { color: var(--text-softer); }
    .hero-right-value { font-weight: 600; color: #d1fae5; }

    @media (max-width: 780px) {
      .hero-content { flex-direction: column; }
      .hero-right { width: 100%; }
    }

    /* Controls + small metrics row */

    .top-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
      flex-wrap: wrap;
    }
    .top-left {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .chips {
      display: inline-flex;
      gap: 4px;
      border-radius: 9999px;
      padding: 3px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #111827;
    }
    .chip {
      border-radius: 9999px;
      padding: 3px 10px;
      font-size: 0.8rem;
      color: var(--text-soft);
      border: 1px solid transparent;
    }
    .chip.active {
      border-color: rgba(239, 68, 68, 0.7);
      background: rgba(239, 68, 68, 0.1);
      color: #fecaca;
    }
    .small-label {
      font-size: 0.78rem;
      color: var(--text-soft);
      margin-right: 4px;
    }
    .small-input {
      background: #020617;
      border-radius: 9999px;
      border: 1px solid #111827;
      padding: 4px 9px;
      font-size: 0.8rem;
      color: var(--text);
      width: 80px;
    }
    .status {
      font-size: 0.78rem;
      color: var(--text-softer);
    }
    .status.error { color: #fecaca; }

    .mini-metrics {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 14px;
    }
    @media (max-width: 820px) {
      .mini-metrics { grid-template-columns: minmax(0, 1fr); }
    }
    .mini-card {
      border-radius: 16px;
      padding: 8px 11px;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.95), #020617);
      border: 1px solid #111827;
      box-shadow: var(--shadow-card);
      font-size: 0.8rem;
      position: relative;
      overflow: hidden;
    }
    .mini-label { color: var(--text-soft); margin-bottom: 3px; }
    .mini-value { font-size: 1.15rem; font-weight: 700; }
    .mini-sub { font-size: 0.75rem; color: var(--text-softer); margin-top: 2px; }
    .mini-pill {
      position: absolute;
      top: 7px;
      right: 9px;
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 9999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
    }
    .mini-pill.green { border-color: rgba(34, 197, 94, 0.7); color: #bbf7d0; }

    /* Match cards (compact + expanded) */

    .panel-matches {
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid var(--border-subtle);
      padding: 10px 12px;
      box-shadow: var(--shadow-card);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .panel-title { font-size: 0.96rem; font-weight: 600; }
    .panel-subtitle { font-size: 0.78rem; color: var(--text-softer); }

    .matches-list {
      margin-top: 6px;
      max-height: 540px;
      overflow-y: auto;
      padding-right: 4px;
    }

    @keyframes fadeUp {
      0% { opacity: 0; transform: translateY(8px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .match-card {
      border-radius: 14px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.98), #020617);
      border: 1px solid #111827;
      padding: 9px 10px;
      margin-bottom: 8px;
      font-size: 0.84rem;
      cursor: pointer;
      transition: border-color 0.18s ease-out, box-shadow 0.18s ease-out, transform 0.18s ease-out, background 0.18s ease-out;
      animation: fadeUp 0.4s ease-out both;
      animation-delay: calc(var(--card-index, 0) * 40ms);
    }

    .match-card:hover {
      border-color: rgba(148, 163, 184, 0.7);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 1);
      transform: translateY(-1px);
    }

    .match-card.expanded {
      background:
        radial-gradient(circle at top left, rgba(34, 197, 94, 0.16), transparent 55%),
        radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.16), transparent 55%),
        #020617;
      border-color: rgba(249, 115, 22, 0.9);
      box-shadow: 0 20px 55px rgba(15, 23, 42, 1), 0 0 0 1px rgba(248, 113, 22, 0.7);
      transform: translateY(-2px);
    }

    .match-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .match-team {
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
    }
    .match-team-home { text-align: left; }
    .match-team-away { text-align: right; flex-direction: row-reverse; }

    .team-name {
      font-weight: 600;
      font-size: 0.86rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .team-orb {
      width: 26px;
      height: 26px;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      color: #f9fafb;
      position: relative;
      overflow: hidden;
    }
    .team-orb::after {
      content: "";
      position: absolute;
      inset: 2px;
      border-radius: inherit;
      border: 1px solid rgba(248, 250, 252, 0.35);
      box-shadow: inset 0 0 10px rgba(15, 23, 42, 0.9);
    }
    .home-orb {
      background: radial-gradient(circle at 30% 20%, #bbf7d0, #22c55e 45%, #16a34a 100%);
      box-shadow: 0 0 25px rgba(34, 197, 94, 0.9);
    }
    .away-orb {
      background: radial-gradient(circle at 30% 20%, #bfdbfe, #3b82f6 45%, #1d4ed8 100%);
      box-shadow: 0 0 25px rgba(59, 130, 246, 0.9);
    }

    .match-center {
      text-align: center;
      min-width: 0;
    }
    .headline {
      font-weight: 600;
      font-size: 0.86rem;
    }
    .headline span {
      padding: 1px 7px;
      border-radius: 9999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }
    .kickoff {
      font-size: 0.75rem;
      color: var(--text-softer);
      margin-top: 2px;
    }

    .match-value-pill {
      margin-top: 4px;
      font-size: 0.75rem;
      color: #bbf7d0;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      border-radius: 9999px;
      padding: 2px 8px;
      border: 1px solid rgba(34, 197, 94, 0.7);
      background: rgba(22, 163, 74, 0.12);
    }

    .match-body {
      margin-top: 6px;
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: max-height 0.22s ease-out, opacity 0.22s ease-out, margin-top 0.22s ease-out;
    }
    .match-card.expanded .match-body {
      max-height: 420px;
      opacity: 1;
      margin-top: 8px;
    }

    .match-body-top {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .confidence {
      width: 88px;
      height: 88px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .confidence-ring {
      width: 70px;
      height: 70px;
      border-radius: 9999px;
      background:
        conic-gradient(#22c55e 0deg var(--ring-angle, 120deg), #111827 var(--ring-angle, 120deg) 360deg);
      display: flex;
      align-items: center;
      justify-content: center;
      animation: ringSpin 8s linear infinite;
    }
    @keyframes ringSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .confidence-inner {
      width: 48px;
      height: 48px;
      border-radius: 9999px;
      background: radial-gradient(circle at top, #020617, #020617);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9), 0 0 18px rgba(15, 23, 42, 0.9);
    }
    .confidence-value {
      font-size: 0.9rem;
      font-weight: 700;
    }
    .confidence-label {
      font-size: 0.6rem;
      color: var(--text-softer);
      letter-spacing: 0.06em;
    }

    .body-meta {
      flex: 1;
      font-size: 0.8rem;
    }
    .meta-line { margin-bottom: 3px; }
    .meta-line strong { color: var(--text-soft); }

    .match-body-bottom {
      margin-top: 6px;
      font-size: 0.8rem;
    }

    .scorers-label {
      color: var(--text-soft);
      margin-bottom: 3px;
    }
    .scorers-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
    }
    .scorer-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 7px;
      border-radius: 9999px;
      border: 1px solid #111827;
      background: rgba(15, 23, 42, 0.95);
      font-size: 0.74rem;
    }
    .scorer-photo {
      width: 18px;
      height: 18px;
      border-radius: 9999px;
      object-fit: cover;
      border: 1px solid #1f2937;
    }
    .scorer-name { font-weight: 500; }
    .scorer-xg { color: var(--text-softer); }

    .match-reasoning {
      margin-top: 4px;
    }
    .match-reasoning strong { color: var(--text-soft); }

    .empty {
      font-size: 0.8rem;
      color: var(--text-softer);
      margin-top: 4px;
    }

    @media (max-width: 720px) {
      .matches-list { max-height: none; }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-logo">W</div>
      <div class="brand-text">
        <div class="brand-name">WINMATIC</div>
        <div class="brand-tagline">AI Match Edge Engine</div>
      </div>
    </div>
    <nav class="nav">
      <div class="nav-item active" data-section="dashboard">Dashboard</div>
      <div class="nav-item" data-section="predictions">Predictions</div>
      <div class="nav-item" data-section="value">Value Scanner</div>
      <div class="nav-item" data-section="results">Results (coming soon)</div>
      <div class="nav-item" data-section="contact">Contact</div>
    </nav>
    <div class="sidebar-footer">
      Backend: <code>/predict/upcoming</code>, <code>/value/upcoming</code>, <code>/model-info</code>.<br />
      Tweak this UI in <code>static/predictor.html</code>.
    </div>
  </aside>

  <main class="main">
    <!-- HERO -->
    <section class="hero" id="section-dashboard">
      <div class="hero-glow"></div>
      <div class="hero-content">
        <div class="hero-left">
          <div class="eyebrow">
            <span class="eyebrow-dot"></span>
            Live engine online · Model-backed probabilities
          </div>
          <h1 class="hero-title">
            Premium <span class="hero-highlight">AI Football</span> predictions with live reasoning.
          </h1>
          <p class="hero-subtitle">
            WinMatic ingests historical fixtures, team strength, form and congestion to produce calibrated
            scorelines, win probabilities and value signals – then explains every pick in plain language.
          </p>
          <div class="hero-buttons">
            <button class="btn btn-primary" id="ctaPredictions">View upcoming predictions →</button>
            <button class="btn btn-secondary" id="ctaValue">Scan for value edges</button>
          </div>
        </div>
        <div class="hero-right">
          <div class="hero-right-title">Model snapshot</div>
          <div class="hero-right-row">
            <span class="hero-right-label">League</span>
            <span class="hero-right-value" id="metricLeague">—</span>
          </div>
          <div class="hero-right-row">
            <span class="hero-right-label">Samples</span>
            <span class="hero-right-value" id="metricSamples">—</span>
          </div>
          <div class="hero-right-row">
            <span class="hero-right-label">Log loss</span>
            <span class="hero-right-value" id="metricLogloss">—</span>
          </div>
          <div class="hero-right-row">
            <span class="hero-right-label">Brier score</span>
            <span class="hero-right-value" id="metricBrier">—</span>
          </div>
        </div>
      </div>
    </section>

    <!-- SMALL CONTROLS + MINI METRICS -->

    <section>
      <div class="top-controls">
        <div class="top-left">
          <div class="chips">
            <div class="chip active">All time</div>
            <div class="chip">Last 30 days*</div>
            <div class="chip">Last 7 days*</div>
          </div>
          <div>
            <span class="small-label">League</span>
            <input id="leagueInput" class="small-input" type="number" value="39" />
          </div>
          <div>
            <span class="small-label">Days ahead</span>
            <input id="daysInput" class="small-input" type="number" value="7" min="1" max="14" />
          </div>
        </div>
        <div id="status" class="status"></div>
      </div>

      <div class="mini-metrics">
        <div class="mini-card">
          <div class="mini-pill green">Live</div>
          <div class="mini-label">Upcoming matches scanned</div>
          <div class="mini-value" id="metricUpcoming">0</div>
          <div class="mini-sub">Fixtures in the selected window.</div>
        </div>
        <div class="mini-card">
          <div class="mini-pill green">AI Edge</div>
          <div class="mini-label">Value spots found</div>
          <div class="mini-value" id="metricValueCount">0</div>
          <div class="mini-sub">Where model disagrees with the market.</div>
        </div>
        <div class="mini-card">
          <div class="mini-pill">Model</div>
          <div class="mini-label">Calibration snapshot</div>
          <div class="mini-value" id="metricCalib">—</div>
          <div class="mini-sub">Log loss / Brier on holdout set.</div>
        </div>
      </div>
    </section>

    <!-- MATCH CARDS -->

    <section class="panel-matches" id="panelMatches">
      <div class="panel-header">
        <div>
          <div class="panel-title">Matches in next window</div>
          <div class="panel-subtitle">Tap a card to expand into a hero view.</div>
        </div>
      </div>
      <div class="matches-list" id="matchesList"></div>
    </section>

    <!-- Results / Contact placeholders (for nav) -->
    <section id="section-results" style="display:none;margin-top:12px;">
      <div class="panel-matches">
        <div class="panel-header"><div class="panel-title">Results & tracking</div></div>
        <div class="matches-list">
          <p class="empty">
            This section will show historical performance once you plug in a results endpoint.
          </p>
        </div>
      </div>
    </section>
    <section id="section-contact" style="display:none;margin-top:12px;">
      <div class="panel-matches">
        <div class="panel-header"><div class="panel-title">Contact</div></div>
        <div class="matches-list">
          <p class="empty">
            Add your contact / subscription info here (email, Discord, Telegram, etc).
          </p>
        </div>
      </div>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);
    const leagueInput = $("leagueInput");
    const daysInput = $("daysInput");
    const matchesList = $("matchesList");

    let currentLeague = 39;
    let currentDays = 7;
    let latestPreds = [];
    let latestValueMap = {};

    function setStatus(msg, isError=false) {
      const el = $("status");
      el.textContent = msg || "";
      el.classList.toggle("error", !!isError);
    }

    function escapeHtml(str) {
      if (!str) return "";
      return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    function fmtProb(p) { return (p || 0).toFixed(2); }
    function fmtNum(n) {
      if (n == null || isNaN(n)) return "—";
      if (n >= 1000000) return (n/1e6).toFixed(1) + "M";
      if (n >= 1000) return (n/1e3).toFixed(1) + "k";
      return String(n);
    }

    async function fetchModelInfo() {
      try {
        const res = await fetch(`/model-info?league=${encodeURIComponent(currentLeague)}`);
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }

    async function fetchPredictions() {
      const url = `/predict/upcoming?league=${encodeURIComponent(currentLeague)}&days_ahead=${encodeURIComponent(currentDays)}`;
      const res = await fetch(url);
      return res.json();
    }

    async function fetchValue() {
      const url = `/value/upcoming?league=${encodeURIComponent(currentLeague)}&days_ahead=${encodeURIComponent(currentDays)}`;
      const res = await fetch(url);
      return res.json();
    }

    function renderModelMetrics(modelInfo) {
      if (!modelInfo || !modelInfo.info) return;
      const meta = modelInfo.info;
      const m = meta.metrics || {};

      $("metricLeague").textContent = meta.league || currentLeague;
      $("metricSamples").textContent = fmtNum(m.samples_total || 0);

      const logloss = m.logloss_1x2;
      const brier = m.brier_1x2;
      const logStr = logloss == null ? "—" : logloss.toFixed(3);
      const brStr  = brier == null ? "—" : brier.toFixed(3);

      $("metricLogloss").textContent = logStr;
      $("metricBrier").textContent = brStr;
      $("metricCalib").textContent = `${logStr} / ${brStr}`;
    }

    function renderMatches() {
      if (!latestPreds.length) {
        matchesList.innerHTML = '<div class="empty">No fixtures in this window – try another league or days range.</div>';
        $("metricUpcoming").textContent = "0";
        $("metricValueCount").textContent = "0";
        return;
      }

      $("metricUpcoming").textContent = fmtNum(latestPreds.length);
      $("metricValueCount").textContent = fmtNum(Object.keys(latestValueMap).length);

      const html = latestPreds.map((fx, idx) => {
        const preds = fx.predictions || {};
        const value = latestValueMap[fx.fixture_id];
        const home = escapeHtml(fx.home_name || "Home");
        const away = escapeHtml(fx.away_name || "Away");
        const kickoff = escapeHtml(fx.kickoff_utc || "");
        const reasoning = escapeHtml(fx.reasoning || "");

        const ph = preds.home_win_p || 0;
        const pd = preds.draw_p || 0;
        const pa = preds.away_win_p || 0;
        const xh = preds.home_goals || 0;
        const xa = preds.away_goals || 0;

        const maxProb = Math.max(ph, pd, pa);
        const maxPct = Math.round(maxProb * 100);
        const angle = Math.round(maxProb * 360);
        const headlineText = `${Math.round(ph*100)}% – ${Math.round(pa*100)}%`;

        const stats = fx.stats || {};
        const xgHome = (stats.xg && stats.xg[0] != null) ? stats.xg[0] : xh;
        const xgAway = (stats.xg && stats.xg[1] != null) ? stats.xg[1] : xa;
        const sotHome = stats.shots_on_target ? stats.shots_on_target[0] : null;
        const sotAway = stats.shots_on_target ? stats.shots_on_target[1] : null;
        const corHome = stats.corners ? stats.corners[0] : null;
        const corAway = stats.corners ? stats.corners[1] : null;
        const yHome   = stats.yellows ? stats.yellows[0] : null;
        const yAway   = stats.yellows ? stats.yellows[1] : null;
        const rHome   = stats.reds ? stats.reds[0] : null;
        const rAway   = stats.reds ? stats.reds[1] : null;

        const scorers = fx.players_to_score || fx.likely_scorers || [];
        const bestEdge = value ? (value.best_edge * 100).toFixed(1) : null;
        const bestSide = value ? value.best_side : null;

        const homeInitial = home.charAt(0) || "H";
        const awayInitial = away.charAt(0) || "A";

        const valuePill = value
          ? `<div class="match-value-pill">Best: ${escapeHtml(bestSide || "?")} · edge ${bestEdge}%</div>`
          : "";

        const scorerHtml = scorers.slice(0, 5).map(s => {
          const name = escapeHtml(s.name || "");
          const team = escapeHtml(s.team || "");
          const xg = (s.xg_anytime != null) ? s.xg_anytime : null;
          const pct = xg != null ? Math.round(xg * 100) : null;
          const photo = escapeHtml(s.photo || "");
          return `
            <div class="scorer-chip">
              ${photo ? `<img class="scorer-photo" src="${photo}" alt="">` : ""}
              <span class="scorer-name">${name}</span>
              <span class="scorer-xg">${team}${pct != null ? " · " + pct + "%" : ""}</span>
            </div>
          `;
        }).join("");

        return `
          <article class="match-card ${idx === 0 ? "expanded" : ""}" data-fixture-id="${fx.fixture_id}" style="--card-index:${idx};">
            <div class="match-header">
              <div class="match-team match-team-home">
                <div class="team-orb home-orb">${homeInitial}</div>
                <div class="team-name">${home}</div>
              </div>
              <div class="match-center">
                <div class="headline"><span>${headlineText}</span></div>
                <div class="kickoff">${kickoff}</div>
              </div>
              <div class="match-team match-team-away">
                <div class="team-name">${away}</div>
                <div class="team-orb away-orb">${awayInitial}</div>
              </div>
            </div>
            ${valuePill}
            <div class="match-body">
              <div class="match-body-top">
                <div class="confidence">
                  <div class="confidence-ring" style="--ring-angle:${angle}deg;">
                    <div class="confidence-inner">
                      <div class="confidence-value">${maxPct}%</div>
                      <div class="confidence-label">CONFIDENCE</div>
                    </div>
                  </div>
                </div>
                <div class="body-meta">
                  <div class="meta-line">
                    <strong>Probabilities:</strong>
                    Home ${fmtProb(ph)} · Draw ${fmtProb(pd)} · Away ${fmtProb(pa)}
                  </div>
                  <div class="meta-line">
                    <strong>Expected goals:</strong>
                    ${xgHome.toFixed(2)} : ${xgAway.toFixed(2)}
                  </div>
                  <div class="meta-line">
                    <strong>Stats:</strong>
                    SOT ${sotHome ?? "-"}–${sotAway ?? "-"},
                    Corners ${corHome ?? "-"}–${corAway ?? "-"},
                    Cards ${yHome ?? "-"}–${yAway ?? "-"} / ${rHome ?? "-"}–${rAway ?? "-"}
                  </div>
                </div>
              </div>
              <div class="match-body-bottom">
                <div class="scorers-label">Players to score</div>
                <div class="scorers-chips">
                  ${scorerHtml || '<span class="scorer-xg">No scorer data available.</span>'}
                </div>
                <div class="match-reasoning">
                  <strong>Reasoning:</strong> ${reasoning}
                </div>
              </div>
            </div>
          </article>
        `;
      }).join("");

      matchesList.innerHTML = html;

      // Click handlers: only one expanded at a time
      document.querySelectorAll(".match-card").forEach(card => {
        card.addEventListener("click", () => {
          document.querySelectorAll(".match-card.expanded").forEach(c => {
            if (c !== card) c.classList.remove("expanded");
          });
          card.classList.toggle("expanded");
        });
      });
    }

    async function refreshAll() {
      currentLeague = Number(leagueInput.value) || 39;
      currentDays = Number(daysInput.value) || 7;

      setStatus("Loading model, predictions & value edges…");
      matchesList.innerHTML = "";

      const [modelInfoRes, predsRes, valueRes] = await Promise.allSettled([
        fetchModelInfo(),
        fetchPredictions(),
        fetchValue()
      ]);

      if (modelInfoRes.status === "fulfilled" && modelInfoRes.value) {
        renderModelMetrics(modelInfoRes.value);
      }

      latestValueMap = {};
      if (valueRes.status === "fulfilled") {
        const vd = valueRes.value;
        if (vd && vd.ok) {
          (vd.fixtures || []).forEach(v => {
            if (v.fixture_id != null) {
              latestValueMap[String(v.fixture_id)] = v;
            }
          });
        }
      }

      if (predsRes.status === "fulfilled") {
        const d = predsRes.value;
        if (d && d.ok) {
          latestPreds = d.fixtures || [];
        } else {
          latestPreds = [];
        }
      } else {
        latestPreds = [];
      }

      renderMatches();
      setStatus("");
    }

    // Nav wiring
    function activateNav(section) {
      document.querySelectorAll(".nav-item").forEach(el => {
        el.classList.toggle("active", el.dataset.section === section);
      });

      const dashVisible = (section === "dashboard" || section === "predictions" || section === "value");
      $("section-dashboard").style.display = dashVisible ? "" : "none";
      $("panelMatches").style.display = dashVisible ? "" : "none";
      $("section-results").style.display = (section === "results") ? "" : "none";
      $("section-contact").style.display = (section === "contact") ? "" : "none";

      if (section === "predictions" || section === "value") {
        window.scrollTo({ top: 260, behavior: "smooth" });
      } else {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    }

    document.querySelectorAll(".nav-item").forEach(el => {
      el.addEventListener("click", () => {
        activateNav(el.dataset.section);
      });
    });

    $("ctaPredictions").addEventListener("click", () => activateNav("predictions"));
    $("ctaValue").addEventListener("click", () => activateNav("value"));

    leagueInput.addEventListener("change", refreshAll);
    daysInput.addEventListener("change", refreshAll);

    // Initial load
    refreshAll();
  </script>
</body>
</html>
